<ng-container *ngIf="info$ | async as info">

  <nb-card *ngIf="!showLogs">
    <nb-card-header>{{ 'SYSTEM.OVERVIEW' | translate }}</nb-card-header>
    <nb-card-body>
      <table class="overview-table">
        <tr>
          <td><b>{{ 'SYSTEM.MODEL' | translate }}:</b></td>
          <td>{{ info.deviceModel }} ({{ info.ASICModel }})</td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.UPTIME' | translate }}:</b></td>
          <td>
            <span [title]="getBootTime(info.uptimeSeconds) | date:'medium'">
              {{ info.uptimeSeconds | dateAgo }}
            </span>&nbsp;&nbsp;&nbsp;

            <button nbButton size="small" (click)="restart()" status="danger">
              {{ 'SYSTEM.RESTART' | translate }}
            </button>
            &nbsp;
            <button nbButton size="small" (click)="shutdown()" status="warning">
              {{ 'SYSTEM.SHUTDOWN' | translate }}
            </button>
          </td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.LAST_RESET_REASON' | translate }}:</b></td>
          <td>{{ info.lastResetReason | translate }}</td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.WIFI_STATUS' | translate }}:</b></td>
          <td>
            <span class="wifi-status-combined">
              {{ info.wifiStatus | translate }}
              <span class="rssi-inline">
                ({{ info.wifiRSSI }} dBm)
                <div class="wifi-bars" [attr.title]="getRssiTooltip(info.wifiRSSI)">
                  <div class="bar" [class.active]="info.wifiRSSI > -85"></div>
                  <div class="bar" [class.active]="info.wifiRSSI > -75"></div>
                  <div class="bar" [class.active]="info.wifiRSSI > -65"></div>
                  <div class="bar" [class.active]="info.wifiRSSI > -55"></div>
                </div>
              </span>
            </span>
          </td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.MAC_ADDRESS' | translate }}:</b></td>
          <td>{{ info.macAddr }}</td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.FREE_HEAP_MEMORY' | translate }}:</b></td>
          <td>SRAM: {{ info.freeHeapInt }}, PSRAM: {{ info.freeHeap }}</td>
        </tr>
        <tr>
          <td><b>{{ 'SYSTEM.VERSION' | translate }}:</b></td>
          <td>{{ info.version }}</td>
        </tr>
        <!-- Collaboration trigger: only for NerdQX -->
        <tr *ngIf="info.deviceModel === 'NerdQX'">
          <td></td>
          <td class="collab-card no-border">
            <nb-card class="collab-card">
              <nb-card-header class="collab-header">
                <span class="text-hint"
                      (click)="openLink('https://github.com/IxTechCrypto/NerdQX')"
                      role="button"
                      tabindex="0"
                      title="NerdQX repository on Github">
                  <u>NerdQX</u>
                </span>
                <span class="text-hint" [innerHTML]="'SYSTEM.ABOUT_NERDQX' | translate"></span>
                <span class="text-hint"
                      (click)="openLink('https://plebbase.com/nerdqx-original')"
                      role="button"
                      tabindex="0"
                      title="NerdQX ORIGINAL initiative">
                  <span [innerHTML]="'SYSTEM.ABOUT_NERDQX_ORIGINAL' | translate"></span>
                </span>.
              </nb-card-header>

              <nb-card-body>
                <div class="collab-grid">
                  <!-- Column headers -->
                  <div class="colhead"></div>
                  <div class="colhead"></div>
                  <div class="colhead text-hint">phil31</div>
                  <div class="colhead text-hint">shufps</div>

                  <!-- Logos row (clickable tiles) -->
                  <div class="logo-cell clickable"
                       (click)="openLink('https://ixtech.xyz')"
                       role="button"
                       tabindex="0"
                       title="Ix Tech – Website"
                       aria-label="Ix Tech – Website">
                    <img class="logo" src="/assets/IxTech{{ logoPrefix }}.png" alt="Ix Tech logo" />
                  </div>

                  <div class="logo-cell clickable"
                       (click)="openLink('https://plebbase.com')"
                       role="button"
                       tabindex="0"
                       title="PlebBase – Website"
                       aria-label="PlebBase – Website">
                    <img class="logo" src="/assets/PlebBase{{ logoPrefix }}.png" alt="PlebBase logo" />
                  </div>

                  <div class="logo-cell clickable"
                       (click)="openLink('https://github.com/phil31')"
                       role="button"
                       tabindex="0"
                       title="phil31 – GitHub"
                       aria-label="phil31 – GitHub">
                    <nb-icon icon="github-outline" class="gh-l" aria-label="GitHub"></nb-icon>
                  </div>

                  <div class="logo-cell clickable"
                       (click)="openLink('https://github.com/shufps')"
                       role="button"
                       tabindex="0"
                       title="shufps – GitHub"
                       aria-label="shufps – GitHub">
                    <nb-icon icon="github-outline" class="gh-l" aria-label="GitHub"></nb-icon>
                  </div>

                  <!-- X/Twitter row -->
                  <div class="logo-cell x-cell"
                       (click)="openLink('https://x.com/IxTechCrypto')"
                       role="button"
                       tabindex="0"
                       title="Ix Tech – X (Twitter)"
                       aria-label="Ix Tech – X (Twitter)">
                    <div class="x-tile">
                      <img class="x-logo" src="/assets/x-logo.png" alt="X (Twitter) logo" />
                    </div>
                  </div>

                  <div class="logo-cell x-cell"
                       (click)="openLink('https://x.com/trendkraft')"
                       role="button"
                       tabindex="0"
                       title="PlebBase – X (Twitter)"
                       aria-label="PlebBase – X (Twitter)">
                    <div class="x-tile">
                      <img class="x-logo" src="/assets/x-logo.png" alt="X (Twitter) logo" />
                    </div>
                  </div>

                  <div class="logo-cell x-cell"><!-- no X link --></div>

                  <div class="logo-cell x-cell"
                       (click)="openLink('https://x.com/Pmaxsd')"
                       role="button"
                       tabindex="0"
                       title="shufps – X (Twitter)"
                       aria-label="shufps – X (Twitter)">
                    <div class="x-tile">
                      <img class="x-logo" src="/assets/x-logo.png" alt="X (Twitter) logo" />
                    </div>
                  </div>
                </div>
              </nb-card-body>
            </nb-card>
          </td>
        </tr>
      </table>
    </nb-card-body>
  </nb-card>

  <!-- LOGS CARD: always visible (button always there), content only if showLogs -->
  <nb-card class="mt-4">
    <nb-card-header style="display: flex; align-items: center; flex-wrap: nowrap;">
      {{ 'SYSTEM.REALTIME_LOGS' | translate }}

      <button nbButton size="small" status="primary" (click)="toggleLogs()" style="margin-left: 15px;">
        {{ showLogs ? ('SYSTEM.HIDE' | translate) : ('SYSTEM.SHOW' | translate) }}
        {{ 'SYSTEM.LOGS' | translate }}
      </button>

      <button nbButton
              size="small"
              status="warning"
              (click)="toggleScrolling()"
              *ngIf="showLogs"
              style="margin-left: 15px;">
        {{ stopScroll ? ('SYSTEM.START' | translate) : ('SYSTEM.STOP' | translate) }}
        {{ 'SYSTEM.SCROLLING' | translate }}
      </button>

      <button nbButton
              size="small"
              status="success"
              *ngIf="showLogs"
              [disabled]="logs.length === 0"
              (click)="downloadLogs()"
              style="margin-left: 15px;">
        <nb-icon icon="download-outline" class="download-icon" aria-hidden="true"></nb-icon>
        {{ 'SYSTEM.DOWNLOAD_LOGS' | translate }}
      </button>

      <div *ngIf="showLogs" style="display: flex; align-items: center; margin-left: 15px; margin-top: 0;">
        <button nbButton
                size="small"
                status="info"
                (click)="logFilterText = ''; applyFilter(); onFilterMaybeScroll()"
                style="margin-right: 10px;">
          {{ 'SYSTEM.CLEAR_FILTER' | translate }}
        </button>

        <label for="logFilterText" style="margin-right: 5px;">
          {{ 'SYSTEM.FILTER' | translate }}
        </label>

        <input id="logFilterText"
               type="text"
               [(ngModel)]="logFilterText"
               (ngModelChange)="applyFilter(); onFilterMaybeScroll()"
               [placeholder]="'SYSTEM.FILTER_LOGS_PLACEHOLDER' | translate"
               style="margin-left: 5px; flex-grow: 1; width: calc(100% - 210px);" />
      </div>
    </nb-card-header>

    <nb-alert
      status="info"
      *ngIf="logsLockedByOtherTab && !showLogs"
      class="mt-2">
      {{ 'SYSTEM.LOGS_ALREADY_OPEN_OTHER_TAB' | translate }}
    </nb-alert>

    <nb-card-body *ngIf="showLogs">
      <cdk-virtual-scroll-viewport
        class="logs-viewport"
        [itemSize]="logItemSize"
        [minBufferPx]="minBufferPx"
        [maxBufferPx]="maxBufferPx"
        #viewport>

        <div
          class="log-entry"
          *cdkVirtualFor="let log of filteredLogs; trackBy: trackByLogId"
          [innerHTML]="(formatLogForUi(log.text) | ANSI)">
        </div>

      </cdk-virtual-scroll-viewport>
    </nb-card-body>
  </nb-card>

</ng-container>
